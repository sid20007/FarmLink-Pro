<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | AgriConnect</title>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* Input Styles */
        .input-group input {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.08);
            /* slight border */
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #10b981;
            /* emerald-500 */
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        /* Toggle Button */
        .toggle-btn {
            background: transparent;
            color: #64748b;
        }

        .toggle-btn.active {
            background: #ffffff;
            color: #0f172a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #0f172a;
            color: #fff;
            text-align: center;
            border-radius: 99px;
            padding: 16px 24px;
            position: fixed;
            z-index: 100;
            left: 50%;
            top: 30px;
            /* Top */
            bottom: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            font-weight: 600;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                top: 0;
                opacity: 0;
            }

            to {
                top: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                top: 30px;
                opacity: 1;
            }

            to {
                top: 0;
                opacity: 0;
            }
        }

        .animate-up {
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-100 relative overflow-hidden font-sans">

    <!-- Background Image -->
    <div class="absolute inset-0 z-0">
        <img src="https://images.unsplash.com/photo-1625246333195-5848c428ad69?q=80&w=2560&auto=format&fit=crop"
            class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-tr from-emerald-900/60 via-slate-900/30 to-transparent"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Main Card -->
    <div class="relative z-10 w-full max-w-[480px] p-6 animate-up">

        <div class="glass-card rounded-[2.5rem] p-8 md:p-12">

            <!-- Header -->
            <div class="text-center mb-10">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-emerald-500 text-white mb-6 shadow-xl shadow-emerald-500/30">
                    <i class="fa-solid fa-leaf text-3xl"></i>
                </div>
                <h1 class="text-3xl font-display font-bold text-slate-800 mb-2">AgriConnect</h1>
                <p class="text-slate-600 font-medium" id="header-subtitle">Welcome back, farmer</p>
            </div>

            <!-- Google Sign-In Section (New Backend) -->
            <div class="mb-8">
                <div id="g_id_onload"
                    data-client_id="267198204860-f20gaunl73o5ob3tog36ptkpplkig2m5.apps.googleusercontent.com"
                    data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>

                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                    data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="100%">
                </div>
            </div>

            <!-- Legacy Form (Disabled) -->
            <div class="hidden opacity-50 pointer-events-none relative">
                <div class="absolute inset-0 flex items-center justify-center z-10">
                    <span
                        class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1 rounded-full border border-red-200">Deprecated:
                        Use Google Sign-In</span>
                </div>
                <!-- Toggle Switch -->
                <div class="flex p-1.5 bg-slate-200/50 rounded-xl mb-8">
                    <button id="toggle-login" onclick="setMode('login')"
                        class="toggle-btn active flex-1 py-3.5 rounded-lg text-sm font-bold transition-all">
                        Log In
                    </button>
                    <button id="toggle-register" onclick="setMode('register')"
                        class="toggle-btn flex-1 py-3.5 rounded-lg text-sm font-bold transition-all">
                        Sign Up
                    </button>
                </div>

                <!-- Form -->
                <form id="authForm" onsubmit="handleSubmit(event)" class="space-y-4">

                    <!-- Role Selection (Register Only) -->
                    <div id="role-selector" class="hidden grid grid-cols-2 gap-3 mb-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="role" value="farmer" checked class="peer sr-only"
                                onchange="toggleLocationField()">
                            <div
                                class="p-4 rounded-xl border border-transparent bg-white/60 text-slate-500 text-center peer-checked:bg-emerald-50 peer-checked:text-emerald-700 peer-checked:border-emerald-200 transition-all hover:bg-white/80">
                                <i class="fa-solid fa-tractor mb-2 text-xl"></i><br><span
                                    class="text-xs font-bold uppercase tracking-wider">Farmer</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="role" value="buyer" class="peer sr-only"
                                onchange="toggleLocationField()">
                            <div
                                class="p-4 rounded-xl border border-transparent bg-white/60 text-slate-500 text-center peer-checked:bg-blue-50 peer-checked:text-blue-700 peer-checked:border-blue-200 transition-all hover:bg-white/80">
                                <i class="fa-solid fa-shop mb-2 text-xl"></i><br><span
                                    class="text-xs font-bold uppercase tracking-wider">Buyer</span>
                            </div>
                        </label>
                    </div>

                    <!-- Name Field -->
                    <div id="name-field" class="hidden input-group relative">
                        <input type="text" id="name" placeholder="Full Name"
                            class="w-full pl-12 pr-4 py-4 rounded-xl font-medium text-slate-800 placeholder:text-slate-400">
                        <i
                            class="fa-regular fa-user absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                    </div>

                    <!-- Email Field -->
                    <div class="input-group relative">
                        <input type="email" id="email" required placeholder="Email Address"
                            class="w-full pl-12 pr-4 py-4 rounded-xl font-medium text-slate-800 placeholder:text-slate-400">
                        <i
                            class="fa-regular fa-envelope absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                    </div>

                    <!-- Password Field -->
                    <div class="input-group relative">
                        <input type="password" id="password" required placeholder="Password"
                            class="w-full pl-12 pr-4 py-4 rounded-xl font-medium text-slate-800 placeholder:text-slate-400">
                        <i class="fa-solid fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                    </div>

                    <!-- Location Field -->
                    <div id="location-field" class="hidden input-group relative">
                        <input type="text" id="location" placeholder="City or District"
                            class="w-full pl-12 pr-4 py-4 rounded-xl font-medium text-slate-800 placeholder:text-slate-400">
                        <i
                            class="fa-solid fa-map-pin absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                    </div>

                    <div class="pt-2">
                        <button type="submit" id="submit-btn"
                            class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-xl shadow-slate-900/20 transition-all active:scale-[0.98] text-base">
                            Log In
                        </button>
                    </div>
                </form>

            </div>

            <!-- Bottom Credits -->
            <p class="text-center text-white/80 text-xs mt-8 font-medium tracking-wide">
                &copy; 2026 AgriConnect Inc(demo).
            </p>

        </div>

        <script>
            // State
            let isLogin = true;
            // Use RELATIVE URL to match the backend port automatically
            const apiBase = '/api/auth';

            // Google Auth Callback
            async function handleCredentialResponse(response) {
                console.log("Encoded JWT ID token: " + response.credential);

                try {
                    // Send to Backend
                    const res = await fetch(`${apiBase}/google`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: response.credential })
                    });

                    const data = await res.json();

                    if (!res.ok) throw new Error(data.error || 'Authentication failed');

                    // Success
                    console.log('Login Success:', data);
                    localStorage.setItem('token', data.token);
                    // Backend sends { user: { ... } } structure
                    localStorage.setItem('user', JSON.stringify(data.user));

                    showToast(`Welcome ${data.user.name}! Redirecting...`);

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    showToast(err.message, true);
                }
            }

            // --- Core Functions ---

            function setMode(mode) {
                isLogin = (mode === 'login');

                // UI References
                const title = document.getElementById('header-subtitle');
                const submitBtn = document.getElementById('submit-btn');
                const btnLogin = document.getElementById('toggle-login');
                const btnReg = document.getElementById('toggle-register');

                // Toggle Logic
                if (isLogin) {
                    btnLogin.classList.add('active');
                    btnReg.classList.remove('active');

                    // Hide Register Fields
                    document.getElementById('role-selector').classList.add('hidden');
                    document.getElementById('name-field').classList.add('hidden');
                    document.getElementById('location-field').classList.add('hidden');

                    // Text Updates
                    title.innerText = 'Welcome back, farmer';
                    submitBtn.innerText = 'Log In';
                } else {
                    btnReg.classList.add('active');
                    btnLogin.classList.remove('active');

                    // Show Register Fields
                    document.getElementById('role-selector').classList.remove('hidden');
                    document.getElementById('name-field').classList.remove('hidden');

                    // Check location field explicitly
                    toggleLocationField();

                    // Text Updates
                    title.innerText = 'Join the network';
                    submitBtn.innerText = 'Create Account';
                }
            }

            function toggleLocationField() {
                if (isLogin) return; // Don't show in login mode

                const roleInputs = document.querySelectorAll('input[name="role"]');
                let selectedRole = 'farmer';
                for (const input of roleInputs) {
                    if (input.checked) {
                        selectedRole = input.value;
                        break;
                    }
                }

                const locField = document.getElementById('location-field');
                if (selectedRole === 'farmer') {
                    locField.classList.remove('hidden');
                } else {
                    locField.classList.add('hidden');
                }
            }

            function showToast(msg, isError = false) {
                const toast = document.getElementById("toast");
                toast.innerText = msg;
                toast.style.backgroundColor = isError ? '#ef4444' : '#0f172a'; // Red for error, Dark for success
                toast.className = "show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
            }

            async function handleSubmit(e) {
                e.preventDefault();

                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.7';
                submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';

                // Gather Data
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();

                try {
                    let endpoint = '';
                    let payload = {};

                    if (isLogin) {
                        // --- LOGIN ---
                        endpoint = `${apiBase}/login`;
                        payload = { email, password };
                    } else {
                        // --- REGISTER ---
                        const name = document.getElementById('name').value.trim();
                        const location = document.getElementById('location').value.trim();

                        // Get Role
                        let role = 'farmer';
                        document.querySelectorAll('input[name="role"]').forEach(r => {
                            if (r.checked) role = r.value;
                        });

                        // Validation
                        if (!name) throw new Error("Name is required.");
                        if (role === 'farmer' && !location) throw new Error("Location is required for farmers.");

                        endpoint = `${apiBase}/register`;
                        payload = { name, email, password, role, location };
                    }

                    console.log('Sending request to:', endpoint, payload); // Debug

                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = await res.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.error('Server returned non-JSON:', text);
                        throw new Error('Server connection error. Please try again.');
                    }

                    if (!res.ok) {
                        throw new Error(data.msg || data.message || 'Operation failed');
                    }

                    // Success!
                    console.log('Success:', data);
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    showToast(`Success! Redirecting...`);

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    showToast(err.message, true);
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.innerText = isLogin ? 'Log In' : 'Create Account';
                }
            }

            // Initialize Page
            setMode('login'); // Default to login
        </script>
</body>

</html>